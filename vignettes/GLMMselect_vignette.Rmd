---
title: "GLMMselect: Bayesian model selection for generalized linear mixed models"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
author: Shuangshuang Xu, Marco A. R. Ferreira, Erica M. Porter, and Christopher T. Franck
vignette: >
  %\VignetteIndexEntry{GLMMselect: Bayesian model selection for generalized linear mixed models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(GLMMselect)
```

# Introduction

The `GLMMselect` package provides a novel Bayesian model select approach for the analysis of Poisson and Binary data. `GLMMselect` contains functions to simultaneously select fixed effects and random effects for non-Gaussian data. Full details on the `GLMMselect` can be found in the manuscript (Xu et al. 202X).

This vignette contains a toy example for count data and a case study presented in the manuscript (Xu et al. 202X) to illustrate how `GLMMselect` works. For toy example, the count data are simulated from Poisson GLMM with four candidate fixed effects and two types of random effects (spatial random effects and overdispersion random effects).


# Functions

The function `GLMMselect()` implemented in the `GLMMselect` package is described below:

* Function `GLMMselect()` performs GLMMselect method (Xu et al. 202X) which solves model selection for generalized linear mixed models, given a numeric vector of binary or count data `Y`, a matrix of covariates `X`, a list of covariance matrices for random effects `Sigma`, a list of design matrices for random effects `Z`, the description of the error distribution `family`, and the prior for variance component of random effects `prior`. The function `GLMMselect()` returns the indices of fixed effects and random effects that are identified in the best model.  


# Model

The generalized linear mixed model used in the `GLMMselect` package is
$$ g(\pmb{y})=X\pmb{\beta}+\sum_{q=1}^Q Z_q \pmb{\alpha}_q$$
where

* $g()$ is the link function.
* $\pmb{y}$ is the vector of observations, either binary data or count data.
* $X$ is the matrix of covariates.
* $\pmb{\beta}$ is the vector of regression coefficients.
* $Z_q$ is an incidence matrix relating the random effects $\pmb{\alpha}_q$.
* $\pmb{\alpha}_q$ is a vector of random effects with covariance matrix $\tau_q \Sigma_q$. $\Sigma_q$ is a known semi-positive definite matrix, and $\tau_q$ is an unknown scalar. The common types of $\pmb{\alpha}_q$ can be spatial random effects, longitudinal random effects and overdispersion random effects. 

Currently, `GLMMselect` package can analyze binary responses (`family = "bernoulli"`) and Poisson responses (`family = "poisson"`). The GLMMselect manuscript (Xu et al. 202X) provides details on the priors for $\pmb{\beta}$ and $\tau_q$, and FBF approach to train improper priors. 

# Examples

The `GLMMselect` function requires a vector of observations (either bernoulli or assumed Poisson distributed), a matrix of covariates, a list of design matrices for random effects, and a list of covariance matrices for random effects. 

The vector of observations must be a numeric $n \times 1$ vector. In the GLMMselect package, there is an example simulated from the Poisson generalized linear mixed model with four candidate covariates, a vector of spatial random effects, and a vector of overdispersion random effects. Here are the first five elements of the Poisson simulated vector of observations:

```{r}
data("Y")
Y[1:5]
```

The covariate matrix contains all candidate covariates. Each column corresponds to a candidate covariate. Each row corresponds to the a observation. In this example, the covariates matrix contains four candidate covariates. The covariates in the first two columns are in the true model. Here are the first five rows of the covariate matrix:

```{r}
data("X")
X[1:5,]
```

The design matrices for candidate random effects are input in the list type. In this example, this is a list of two design matrices for two types of random effects. The first component is for spatial random effects. The second component is for overdispersion random effects.

```{r}
data("Z")
Z[[1]][1:5,1:5]
Z[[2]][1:5,1:5]
```

The covariance matrices for candidate random effects are also in the list. In this example, this is a list of two covariance matrices for two types of random effects. The first component is for spatial random effects. The second componet is for overdispersion random effects.

```{r}
data("Sigma")
Sigma[[1]][1:5,1:5]
Sigma[[2]][1:5,1:5]
```

# Simulation study

The function `GLMMselect` implements the Bayesian model selection method for generalized linear mixed models with either Poisson or Bernoulli distributed responses. This function takes inputs of the vector of binary or count observations, the matrix of candidate covariates, the list of covariance matrices for candidate random effects, the list of design matrices for candidate random effects, the distributional family the response follows, the prior distribution for variance component of random effects, and a vector of priori known components to be included. The full details are available in the manuscript (Xu et al. 202X). 

We illustrate `GLMMselect` with Poisson count data, and using approximate reference (AR) prior for variance components of random effects.

```{r}
Model_selection_output <- GLMMselect(Y=Y, X=X, Sigma=Sigma, Z=Z, family="poisson", prior="AR", offset=NULL)
Model_selection_output
```

`GLMMselect` outputs the indices of the covariates and the indices of the random effects which are in the best model. The true model contains the first two covariates and spatial random effects. `GLMMselect` identifies these two covariates and the spatial random effects. 


# Case study

Here is a case study to help illustrate how to use `GLMMselect`. This dataset provides the number of male lip cancer cases in the 56 counties of Scotland during the period 1975-1980, as well as the percentage of the work force employed in agriculture, fishing, or forestry (AFF) as a covariate. The model we consider is
$$
y_i|\mu_i \stackrel{ind}{\sim} \mbox{Poisson}(\mu_i), \ \ \ i=1\dots 56, \\
\log(\mu_i) = \log(n_i)+\pmb{x}_i^T\pmb{\beta}+\alpha_{1i}+\alpha_{2i}, \\
\pmb{\alpha}_1 \sim N(\pmb{0},\tau_1 \Sigma_1), \\
\pmb{\alpha}_2 \sim N(\pmb{0}, \tau_2 \Sigma_2). 
$$

$n_i$ is the expected number of lip cancer cases in the $i^{th}$ county, which are assumed to be known constants. $\pmb{\alpha}_1$ is a vector of spatial random effects. $\pmb{\alpha}_2$ is a vector of overdispersion random effects.

We illustrate `GLMMselect` with lip cancer data, and using half Cauchy (HC) prior for variance components of random effects.

```{r}
lip_cancer_output <- GLMMselect(Y=lipcancer_Y, X=lipcancer_X, Sigma=lipcancer_Sigma, Z=lipcancer_Z, family="poisson", prior="HC", offset=lipcancer_offset)
lip_cancer_output
```









